name: Update README Activity

on:
  schedule:
    - cron: "*/30 * * * *"  # Run every 30 minutes
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update README with recent activity
        uses: actions/github-script@v7
        env:
          GH_USERNAME: mukeshjena
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const username = process.env.GH_USERNAME;
            
            const activityLines = [];
            let count = 0;
            const maxLines = 10;
            const seenRepos = new Set();
            
            try {
              // Fetch user's repositories
              const reposResponse = await github.rest.repos.listForUser({
                username: username,
                sort: 'updated',
                per_page: 10,
                type: 'owner'
              });
              
              const repos = reposResponse.data || [];
              
              // Fetch recent commits from each repository
              for (const repo of repos) {
                if (count >= maxLines) break;
                
                try {
                  const commitsResponse = await github.rest.repos.listCommits({
                    owner: username,
                    repo: repo.name,
                    author: username,
                    per_page: 1
                  });
                  
                  if (commitsResponse.data && commitsResponse.data.length > 0) {
                    const commit = commitsResponse.data[0];
                    const commitMessage = commit.commit.message.split('\n')[0].substring(0, 80);
                    const repoUrl = `https://github.com/${username}/${repo.name}`;
                    const commitUrl = commit.html_url;
                    const date = new Date(commit.commit.author.date);
                    const timeAgo = getTimeAgo(date);
                    
                    if (!seenRepos.has(repo.name)) {
                      activityLines.push(
                        `${count + 1}. ⬆️ Pushed commit to [${repo.name}](${repoUrl})<br>   ${commitMessage}${commitMessage.length > 80 ? '...' : ''} (${timeAgo})`
                      );
                      seenRepos.add(repo.name);
                      count++;
                    }
                  }
                } catch (error) {
                  // Skip repos with no access or errors
                  continue;
                }
              }
            } catch (error) {
              console.log('Error fetching repositories:', error.message);
            }
            
            function getTimeAgo(date) {
              const seconds = Math.floor((new Date() - date) / 1000);
              if (seconds < 60) return 'just now';
              const minutes = Math.floor(seconds / 60);
              if (minutes < 60) return `${minutes}m ago`;
              const hours = Math.floor(minutes / 60);
              if (hours < 24) return `${hours}h ago`;
              const days = Math.floor(hours / 24);
              if (days < 7) return `${days}d ago`;
              const weeks = Math.floor(days / 7);
              return `${weeks}w ago`;
            }
            
            if (activityLines.length === 0) {
              activityLines.push('<!-- No recent activity found -->');
            }
            
            const readmePath = 'README.md';
            let readmeContent = fs.readFileSync(readmePath, 'utf8');
            
            const startMarker = '<!--RECENT_ACTIVITY:start-->';
            const endMarker = '<!--RECENT_ACTIVITY:end-->';
            
            const startIndex = readmeContent.indexOf(startMarker);
            const endIndex = readmeContent.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readmeContent.substring(0, startIndex + startMarker.length);
              const after = readmeContent.substring(endIndex);
              const newContent = before + '\n' + activityLines.join('\n') + '\n' + after;
              
              fs.writeFileSync(readmePath, newContent);
              
              // Commit changes
              const { execSync } = require('child_process');
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "41898282+github-actions[bot]@users.noreply.github.com"');
              execSync('git add README.md');
              execSync('git commit -m "chore: update recent activity [skip ci]" || exit 0');
              execSync('git push');
            }
