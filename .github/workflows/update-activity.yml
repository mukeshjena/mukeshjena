name: Update README Activity

on:
  schedule:
    - cron: "*/30 * * * *"  # Run every 30 minutes
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update README with recent activity
        uses: actions/github-script@v7
        env:
          GH_USERNAME: mukeshjena
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const username = process.env.GH_USERNAME;
            
            // Fetch public events
            let events = [];
            try {
              const response = await github.rest.activity.listPublicEventsForUser({
                username: username,
                per_page: 50
              });
              events = response.data || [];
            } catch (error) {
              console.log('Error fetching events:', error.message);
            }
            
            const activityLines = [];
            let count = 0;
            const maxLines = 10;
            const seenRepos = new Set();
            
            // Process PushEvents
            for (const event of events) {
              if (count >= maxLines) break;
              
              if (event.type === 'PushEvent') {
                const repo = event.repo.name;
                const repoKey = `${repo}-push`;
                
                // Avoid duplicates
                if (seenRepos.has(repoKey)) continue;
                seenRepos.add(repoKey);
                
                const commits = event.payload.commits || [];
                if (commits.length > 0) {
                  const commitMessages = commits
                    .slice(0, 2)
                    .map(c => {
                      const msg = c.message || '';
                      return msg.split('\n')[0].substring(0, 60);
                    })
                    .filter(m => m)
                    .join(', ');
                  
                  const repoUrl = `https://github.com/${repo}`;
                  const commitCount = commits.length;
                  
                  activityLines.push(
                    `${count + 1}. ‚¨ÜÔ∏è Pushed ${commitCount} commit(s) to [${repo}](${repoUrl})${commitMessages ? '<br>   ' + commitMessages + (commitMessages.length > 60 ? '...' : '') : ''}`
                  );
                  count++;
                }
              } else if (event.type === 'PullRequestEvent' && !seenRepos.has(`${event.repo.name}-pr`)) {
                const repo = event.repo.name;
                seenRepos.add(`${repo}-pr`);
                const action = event.payload.action;
                const prTitle = event.payload.pull_request?.title || 'Pull Request';
                const repoUrl = `https://github.com/${repo}`;
                
                activityLines.push(
                  `${count + 1}. üîÄ ${action.charAt(0).toUpperCase() + action.slice(1)} pull request in [${repo}](${repoUrl})<br>   ${prTitle.substring(0, 80)}${prTitle.length > 80 ? '...' : ''}`
                );
                count++;
              } else if (event.type === 'IssuesEvent' && !seenRepos.has(`${event.repo.name}-issue`)) {
                const repo = event.repo.name;
                seenRepos.add(`${repo}-issue`);
                const action = event.payload.action;
                const issueTitle = event.payload.issue?.title || 'Issue';
                const repoUrl = `https://github.com/${repo}`;
                
                activityLines.push(
                  `${count + 1}. üêõ ${action.charAt(0).toUpperCase() + action.slice(1)} issue in [${repo}](${repoUrl})<br>   ${issueTitle.substring(0, 80)}${issueTitle.length > 80 ? '...' : ''}`
                );
                count++;
              }
            }
            
            if (activityLines.length === 0) {
              activityLines.push('<!-- No recent activity found -->');
            }
            
            const readmePath = 'README.md';
            let readmeContent = fs.readFileSync(readmePath, 'utf8');
            
            const startMarker = '<!--RECENT_ACTIVITY:start-->';
            const endMarker = '<!--RECENT_ACTIVITY:end-->';
            
            const startIndex = readmeContent.indexOf(startMarker);
            const endIndex = readmeContent.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readmeContent.substring(0, startIndex + startMarker.length);
              const after = readmeContent.substring(endIndex);
              const newContent = before + '\n' + activityLines.join('\n') + '\n' + after;
              
              fs.writeFileSync(readmePath, newContent);
              
              // Commit changes
              const { execSync } = require('child_process');
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "41898282+github-actions[bot]@users.noreply.github.com"');
              execSync('git add README.md');
              execSync('git commit -m "chore: update recent activity [skip ci]" || exit 0');
              execSync('git push');
            }
